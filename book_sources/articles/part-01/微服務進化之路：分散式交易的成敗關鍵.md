 ## 微服務進化之路：分散式交易的成敗關鍵

在微服務的分散式架構中，**通訊模式**和**協調模式**的選擇對系統性能和一致性至關重要。通訊模式分為**同步**和**非同步**，同步強調即時回應和一致性，適合時效性高的場景；非同步則更具彈性，降低服務耦合度。協調模式包括**Orchestration**和**Choreography**，前者由集中協調者管理，適合複雜場景但擴展性有限；後者強調服務解耦，具備更佳擴展性，但錯誤處理較複雜。

在設計分散式交易系統時，交易一致性通常是一個重要挑戰，對於強調一致性的場景來說，**同步通訊**加上**Orchestration 模式**的組合通常是較佳選擇。同步通訊能確保服務之間的即時回應，減少由非同步通訊帶來的結果延遲或一致性問題。然而，在分散式系統的交易失敗時，由於交易跨越多個服務時，交易的回滾機制是否完善，往往是決定分散式系統能否能夠成功運行的另一大關鍵因素。


### 確保交易一致性的經典策略：SAGA 模式

SAGA 模式的核心在於追求分散式交易中的**最終一致性**，而非強一致性。在微服務架構中，SAGA 允許每個步驟獨立提交，這種設計提高了系統的擴展性和可用性。然而，SAGA 模式也帶來了一個挑戰，就是設計者必須為每個步驟考慮可能的失敗情況，並設計相應的**補償機制**，這使得系統設計變得更加複雜。

![](/book_sources/images/saga_compensation_concept.png)


### 何謂「補償」？

想像一個在分散式交易系統中，每一個交易被拆解為子交易，分別呼叫不同的被調用端服務執行交易步驟（正交易），當某個交易步驟失敗時，需要一個補救機制使得資料得以回復到交易前狀態。然而，不同服務之間無法溝通，無法臨時取消中途失敗的交易步驟，因此「補償」的概念應用而生，透過對每一個交易步驟，定義各自的補償行為來回復失敗的操作，交易發起端可協助分散式交易在錯誤發生時進行一系列的補償操作，使整個交易流程回到交易前狀態，進而確保整個交易的一致性。

![](/book_sources/images/saga_orchestration_rollback_flow.png)

在設計分散式交易架構中，若需要跨越多個微服務進行資料的一致性處理，並且在某一步驟失敗時需要回滾，那麼 SAGA 模式是一個不錯的選擇。


### 影響分散式交易的關鍵因素：網路

SAGA 流程以一系列有序的操作與對應的補償操作，有效地解決了交易回滾方面的問題，維持了系統的一致性。然而，這樣的補償流程在網路延遲、網路故障或系統故障時，可能導致補償操作在實際交易失敗發生前被錯誤觸發，產生 **空補償** (Null Compensation)，即執行補償操作時，實際上沒有對應的原始操作需要回滾。

此外，網路延遲和系統故障也可能使交易處於**懸掛**狀態 (Transaction Hanging)，即交易的一部分已完成，但由於未收到確認或回應而無法繼續或終止，這樣的狀態可能會使系統不確定該如何處理接下來的操作。再者亦可能在空補償後，正交易的請求又到達被調用端服務等特殊狀況。


![](/book_sources/images/saga_flow_of_network_latency.png)


為了解決上述挑戰，可以採取一系列有效的策略來增強系統的穩定性和一致性。首先，透過**狀態控制**來確保正向交易與補償操作的執行順序，確保流程順暢進行。

其次，實施**逾時機制**，確保懸掛的交易能夠在超時後被及時處理或回滾，避免系統長時間處於不確定狀態。**交易協調**則依賴中心化協調器來根據交易狀態判斷何時進行補償或繼續交易，從而減少因網路延遲或故障導致的錯誤決策。

此外，強化**監控與告警**機制，及早發現並處理網路延遲或故障問題，從而減少空補償和交易懸掛的風險。透過這些策略，SAGA 流程能更好地應對網路延遲與故障，防止重複交易與補償問題，從而大幅提高系統的可靠性與一致性。

### 重試機制的衍生問題

在處理網路延遲和失敗的情況下，SAGA 流程中經常會啟動**重試機制**來確保交易的順利完成。然而，這種機制也可能引發新的問題，特別是**重複交易**和**重複補償**的風險。如果在重試交易時未妥善管理，很可能導致系統重複執行相同的操作，進而產生重複交易的現象。同樣地，重試補償操作若未加以控制，則可能引發重複補償，對系統的數據完整性和一致性造成影響。

在**重複交易**的情境中，網路延遲或服務失敗往往會觸發重試操作，確保交易能夠順利完成。然而，當重試發生在系統對原始操作結果狀態尚不明確的情況下，可能導致同一交易被多次執行。例如，假設在一個銀行轉帳場景中，某筆轉帳操作因網路超時而觸發了重試，但實際上最初的轉帳操作已經成功，此時重試操作會導致同一筆資金被多次扣除或轉入，造成不必要的重複交易。這類情況不僅影響系統的正常運作，還會給用戶帶來財務損失和數據錯誤的風險。
 
![](/book_sources/images/saga_flow_of_duplicate_transaction.png)


另外，**重複補償**是另一個可能引發問題的情況。在補償流程中，因網路延遲或服務錯誤，SAGA 系統可能重複執行補償操作，導致補償行為被多次執行。這不僅會對數據的完整性造成影響，還會破壞系統的一致性。因此，設計補償流程時也需要考慮如何避免重複執行，從而保護系統的數據可靠性。

 
![](/book_sources/images/saga_flow_of_duplicate_compensation.png)
 

到目前為止，我們已經介紹了在設計分散式交易系統時，通過結合「同步通信」與「Orchestration模式」和「SAGA 的補償機制」，來實現高度可靠的交易一致性管理。Orchestration 模式集中控制交易流程，確保在每個步驟中的操作都能得到有效協調。

另外，我們也探討在網路環境不穩定的情況下所可能導致「交易懸掛」或「空補償」的情況，以及衍生出「重複交易」與「重複補償」等問題，這些都需要在設計上做額外的處理來應對這些挑戰，以保障系統的穩定性與可恢復性。

### SAGA 模式並非萬靈丹

儘管 SAGA 模式透過「補償機制」良好的控制了分散式交易的回滾控制，實務上仍需要關注補償機制的失敗狀況。SAGA 流程需要對發起端與被調用端做良好的狀態紀錄，並根據操作執行成功與否的狀態採取下一步行動。正交易失敗時雖有補償機制做保障，但是在補償也可能因為某些的原因導致服務中斷、數據不一致、或者系統錯誤等。當補償操作無法成功完成時，需要引入人工作業來解決問題，確保系統的一致性和完整性。這可能涉及手動操作以修復數據狀態、執行特定的業務流程，或進行其他人工處理措施。

此外，在設計分散式交易系統時，即使已經有一套完善的 SAGA流程，面對企業遺留系統不支援 SAGA 補償機制的情況，會造成子交易步驟無法補償而需要人工介入處理，這不僅包括補償失敗時的人工補救措施，也包括正交易失敗時的其他配套處理，如何將分散式交易的設計策略良好的應用在現實的軟體開發中，仍存在許多挑戰。


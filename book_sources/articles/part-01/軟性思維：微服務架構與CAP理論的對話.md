 ## 軟性思維：微服務架構與CAP理論的對話

隨著技術的進步和業務需求的增長，系統架構從單體架構演變到微服務架構，成為許多現代企業必經的過程。這一轉變並不僅僅是技術上的調整，更是涉及到設計哲學和開發策略的深刻變化。在單體架構中，所有功能模塊緊密耦合在一起，使得開發和部署相對簡單，但也容易隨著系統規模增大而變得難以維護。

### 微服務時代：軟體演化的陣痛期

隨著用戶需求的多樣化和系統複雜性的增加，單體架構逐漸暴露出擴展性差、故障隔離困難等問題。這時，微服務架構應運而生，將系統拆分為一系列獨立的服務模塊，每個模塊專注於某一特定功能。這樣的架構設計允許團隊更加靈活地進行開發和部署，提高了系統的可擴展性和容錯能力。

 ![微服務架構問題](/book_sources/images/microservices_cap_theorem.png)

然而，從單體架構轉向微服務架構並非易事，這不僅僅是因為技術上的挑戰，還包括架構決策的困難。微服務的設計要求開發團隊在一開始考慮開發複雜度、延遲性、耦合度、擴展性、狀態控制和可維護性等多方面的影響。因此，許多微服務的設計模式逐漸被軟體開發人員或是架構決策者所重視，包括服務間的通信模式選擇，以及分散式系統的協調模式的取捨等，成為構建微服務架構是否能夠成功的重要課題。這不僅是微服務時代的重大挑戰，也同時也帶來企業業務發展上巨大的潛在利益。

### 面對微服務的複雜性，如何選擇合適的架構模式？

想像你在設計一個金融系統，其中包含多個獨立的服務，比如支付處理、賬戶管理、風險控制等。每個服務都像是一個獨立的部門，專注於自己的一部分工作。這種設計的好處是各部門能夠專精於自己的領域，提高效率和靈活性。

然而，挑戰也隨之而來。比如，當用戶發起一筆支付時，需要經過多個服務的協調：賬戶管理服務要確認賬戶餘額，支付處理服務要執行交易，風險控制服務要進行風險評估。這些步驟必須協調得非常好，才能確保交易的順利進行。

在這裡，微服務架構的兩種協調方式—**Orchestration** 和 **Choreography**—就是我們需要做的權衡點：

1. **Orchestration** 模式就像是一個中央調度員，統一協調所有服務。這樣的好處是所有操作都有一個集中控制點，容易管理和追蹤。例如，支付處理服務可以充當這個調度員，負責呼叫其他服務來完成交易。然而，這種方式也有風險，因為如果這個調度員發生故障，整個交易流程可能會中斷。

2. **Choreography** 模式則像是各個服務之間的“舞蹈”，每個服務知道在什麼時候應該做什麼，沒有一個中央控制點。這種方式的優勢在於高彈性和低耦合，每個服務可以獨立運作，某個服務出現問題時，其他服務仍然可以繼續運行。然而，缺點是當交易涉及多個步驟時，錯誤處理和狀態管理變得更加複雜。

此外，通信模式的選擇也對微服務架構有著深遠的影響，這裡我們有兩種通信模式-**同步通信** 和 **異步通信**-要做權衡：

1. **同步通信** 
同步通信模式意味著服務之間的請求和響應是即時進行的。當一個用戶發起支付時，支付處理服務會同步調用賬戶管理服務來確認餘額，然後再調用風險控制服務來評估風險。這種方式的好處是簡單且直接，能夠迅速得到回應和結果。然而，缺點在於如果某一服務出現延遲或故障，整個交易流程可能會被阻塞，影響用戶體驗和系統穩定性。

2. **異步通信** 
異步通信則允許服務發出請求後不等待立即回應，使用消息隊列等中介系統來處理通信。在異步模式下，支付處理服務可以將交易請求發送給消息隊列，由賬戶管理和風險控制服務在空閒時處理。這種方式提高了系統的彈性和容錯性，但也增加了設計和實現的複雜性，特別是在處理一致性和錯誤恢復時。

在設計這樣的金融系統時，開發團隊必須在系統的**開發複雜度**、**延遲性**、**耦合度**、**擴展性**、**狀態控制**和**可維護性**等因素上，做良好的權衡與決策，這些決策將直接影響系統的穩定性、靈活性和用戶體驗。有沒有什麼更全面的理論基礎，讓我們在構建微服務時的權衡與決策能夠更全面且穩固呢？我們看看著名的-**CAP定理**-怎麼說？


### 讓CAP定理成為微服務的決策指南

CAP定理（CAP Theorem）是一個在分散式計算系統中非常重要的理論，該理論由Eric Brewer於2000年提出。CAP定理指出，任何分散式數據庫系統在同一時間內最多只能滿足一致性（Consistency）、可用性（Availability）和分區容忍性（Partition Tolerance）三個特性中的兩個，無法同時兼顧三者。

 ![CAP定理](/book_sources/images/microservices_cap_theorem_2.png)

1. **一致性（Consistency）**：所有客戶端在同一時間點讀取數據時，應該能夠獲得相同的結果，即數據庫狀態一致。
2. **可用性（Availability）**：系統應該在任何時候都能響應讀寫請求，即使有些節點發生故障。
3. **分區容忍性（Partition Tolerance）**：系統應該能夠繼續運行，即使系統內部的網絡分區（即不同節點之間的通信失效）發生。

根據CAP定理，開發者在設計分散式系統時必須進行權衡和取捨，決定系統在不同情境下應該優先保證哪些特性。這一理論對於理解分散式系統的限制和挑戰，以及做出架構決策具有重要指導意義。

CAP定理是針對分散式數據庫的架構理論，其理論著墨對象為系統中的-**資料(Data)**-的分散議題。同樣的，我們也可以發揮軟性思維，試著用CAP定理這個放大鏡，檢視微服務架構中單體與單體之間的關係，探討一下微服務架構所要面對的是-**服務(Service**)-的分散議題，

 ![微服務架構問題](/book_sources/images/microservices_cap_theorem_3.png)

在微服務架構的設計中，傳統單體架構被拆分為多個小單體的微服務架構後，成為一個分散式的單體系統，單體跟單體之間的網路通信的穩定性與複雜性隨之提升，進而成為影響微服務架構穩定性的重要關鍵。

從CAP定理的角度來看，微服務架構的多的單體的架構本質，相當於已選擇了 **分區容忍性** 這一要素，進而使得剩下的 **一致性** 與 **可用性** 只能選擇其一做到極致，而這就牽涉到我們前面提到的 **通信模式** 與 **協調模式**該如何取捨。我們繼續將前面提到的各種架構權衡重點項目(**開發複雜度**、**延遲性**、**耦合度**、**擴展性**、**狀態控制**和**可維護性**)，套用CAP定理再來檢視一遍。

 ![微服務架構問題](/book_sources/images/microservices_cap_theorem_4.png)

經過歸納整理，可以發現在CAP定理的指導原則下，如果我們的架構強調 **一致性** ，則 **同步通信 + Orchestration模式** 的組合能夠滿足 **CP** 的條件。同樣的，如果我們的架構強調 **可用性** ，則 **異步通信 + Choreography模式** 的組合能夠滿足 **AP** 的條件。

- **同步通信 + Orchestration模式**：強調一致性
- **異步通信 + Choreography模式**：強調可用性

至此，我們用CAP理論為服務的分散議題做了一次檢視，對微服務軟體設計的整體觀有了更深刻的思考，在做架構決策的時候有更全面的理論依據。


### 用更高視角探討CAP理論

我們從觀察微服務的架構特徵，發現許多如**開發複雜度**、**延遲性**、**耦合度**、**擴展性**、**狀態控制**和**可維護性**等議題，進而探討是否有一個思考架構，能夠全面的分析微服務議題的方方面面，並借鏡CAP定理在分散式資料庫的理論框架，從而將CAP定理在-**資料(Data)**-分散議題的探索觀點，進一步提高視角用更抽象的思考層次，轉而對為服務架構的-**服務(Service)**-分散議題做觀察與剖析。同時，我們也透過CAP定理對 **分散式資料庫** 與 **分散式的微服務** 的異同做了對比思考，從具體的系統議題中萃取出抽象的架構概念，讓CAP理論能有更廣義的解釋觀點，我們也因此對微服務架構的全貌有了更深入的體會，正所謂「知所異同，方虧全貌」。

### 科技不斷進步，思維不斷抽象

隨者各種新科技與技術的不斷進步，人工智慧與AI應用也呈現百花齊放的趨勢，未來的軟體世界勢必會有更多豐富的議題等著我們去探索。我們如何透過前人在軟體領域實踐的各種理論與方法，提煉出更高一層次的軟體抽象思維，面對未來各種軟體架構的議題，這將會是未來的軟體世界的重要挑戰。

